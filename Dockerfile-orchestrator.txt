# Dockerfile para o serviço orchestrator (Python)

# Etapa 1: Builder - Instala as dependências em um ambiente virtual
FROM python:3.12-slim AS builder

WORKDIR /app

# Cria venv e instala dependências mínimas do orquestrador
RUN python -m venv /app/.venv && \
    /app/.venv/bin/pip install --no-cache-dir --upgrade pip && \
    /app/.venv/bin/pip install --no-cache-dir fastapi==0.115.6 uvicorn==0.30.6 httpx==0.27.2

# Etapa 2: Final - Cria a imagem de produção final
# Usamos uma imagem distroless para segurança e tamanho reduzido.
FROM python:3.12-slim

WORKDIR /app

# Copia o ambiente virtual com as dependências da etapa de build.
COPY --from=builder /app/.venv /app/.venv

# Copia o código do orquestrador
COPY orchestrator /app/orchestrator

# Adiciona o diretório de binários do ambiente virtual ao PATH do sistema.
ENV PATH="/app/.venv/bin:$PATH"

# Expõe a porta em que o serviço irá rodar.
EXPOSE 8000

# Comando para iniciar a aplicação (proíbe localhost no upstream em runtime)
CMD ["/app/.venv/bin/uvicorn", "orchestrator.main:app", "--host", "0.0.0.0", "--port", "8000"]
